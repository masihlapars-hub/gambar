<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Game Tebak Gambar</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root { --primary:#3498db; --secondary:#2ecc71; --accent:#e74c3c; --text:#2c3e50; --background:#f8f9fa; --card-bg:#ffffff; --border:#ddd; }
    .dark-theme{ --primary:#2980b9; --secondary:#27ae60; --accent:#c0392b; --text:#ecf0f1; --background:#1a1a2e; --card-bg:#16213e; --border:#34495e; }
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;transition:background-color .3s,color .3s}
    body{background-color:var(--background);color:var(--text);min-height:100vh;padding:20px}
    .container{max-width:1200px;margin:0 auto}
    header{display:flex;justify-content:space-between;align-items:center;padding:15px 0;border-bottom:2px solid var(--primary);margin-bottom:30px}
    .logo{font-size:2rem;font-weight:bold;color:var(--primary)}
    nav ul{display:flex;list-style:none;gap:20px}
    nav a{text-decoration:none;color:var(--text);font-weight:500;padding:8px 15px;border-radius:20px;transition:all .3s}
    nav a:hover,nav a.active{background-color:var(--primary);color:#fff}
    .main-content{display:grid;grid-template-columns:1fr 3fr;gap:30px}
    .sidebar{background-color:var(--card-bg);border-radius:15px;padding:20px;box-shadow:0 5px 15px rgba(0,0,0,.1)}
    .user-info{text-align:center;margin-bottom:30px}
    .avatar{width:100px;height:100px;border-radius:50%;border:3px solid var(--primary);margin:0 auto 15px;overflow:hidden}
    .avatar img{width:100%;height:100%;object-fit:cover}
    .username{font-size:1.2rem;font-weight:bold;margin-bottom:5px}
    .user-score{color:var(--secondary);font-weight:500}
    .theme-selector{margin-bottom:30px}
    .theme-selector h3{margin-bottom:15px;padding-bottom:10px;border-bottom:1px solid var(--border)}
    .theme-options{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .theme-btn{padding:10px;border:2px solid var(--border);border-radius:10px;background:none;cursor:pointer;text-align:center;font-weight:500}
    .theme-btn.active{border-color:var(--primary);background-color:var(--primary);color:#fff}
    .content{background-color:var(--card-bg);border-radius:15px;padding:30px;box-shadow:0 5px 15px rgba(0,0,0,.1)}
    .page{display:none}.page.active{display:block}
    .login-form h2,.level-select h2,.game-container h2{margin-bottom:20px;color:var(--primary);text-align:center}
    .form-group{margin-bottom:20px}
    .form-group label{display:block;margin-bottom:8px;font-weight:500}
    .form-group input,.form-group select{width:100%;padding:12px 15px;border:2px solid var(--border);border-radius:8px;font-size:1rem;background-color:var(--background);color:var(--text)}
    .btn{padding:12px 25px;border:none;border-radius:30px;font-size:1rem;font-weight:600;cursor:pointer;transition:all .3s}
    .btn-primary{background-color:var(--primary);color:#fff}
    .btn-primary:hover{background-color:var(--secondary)}
    .btn-secondary{background-color:var(--background);color:var(--text);border:2px solid var(--border)}
    .btn-secondary:hover{background-color:var(--border)}
    .btn-block{display:block;width:100%}
    .levels-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(80px,1fr));gap:15px;margin-top:30px}
    .level-btn{aspect-ratio:1;border-radius:10px;border:2px solid var(--border);background-color:var(--background);color:var(--text);font-size:1.2rem;font-weight:bold;cursor:pointer;transition:all .3s}
    .level-btn.unlocked{border-color:var(--secondary);background-color:rgba(46,204,113,.1)}
    .level-btn.current{border-color:var(--primary);background-color:var(--primary);color:#fff}
    .level-btn.completed{border-color:var(--secondary);background-color:var(--secondary);color:#fff}
    .game-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;padding-bottom:15px;border-bottom:1px solid var(--border)}
    .game-image{width:100%;max-width:500px;height:300px;margin:0 auto 30px;border:3px dashed var(--primary);border-radius:10px;display:flex;align-items:center;justify-content:center;overflow:hidden}
    .game-image img{max-width:100%;max-height:100%;object-fit:contain}
    .game-options{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:30px}
    .option-btn{padding:15px;border:2px solid var(--border);border-radius:10px;background:none;color:var(--text);font-size:1rem;font-weight:500;cursor:pointer;transition:all .3s}
    .option-btn:hover{border-color:var(--primary);background-color:rgba(52,152,219,.1)}
    .option-btn.correct{border-color:var(--secondary);background-color:rgba(46,204,113,.2)}
    .option-btn.incorrect{border-color:var(--accent);background-color:rgba(231,76,60,.2)}
    .game-feedback{text-align:center;font-size:1.2rem;font-weight:bold;margin-bottom:20px;min-height:40px}
    .correct-feedback{color:var(--secondary)} .incorrect-feedback{color:var(--accent)}
    .game-controls{display:flex;justify-content:center;gap:12px;flex-wrap:wrap}
    footer{text-align:center;margin-top:50px;padding-top:20px;border-top:1px solid var(--border);color:var(--text);font-size:.9rem}
    .admin-box{max-width:720px;margin:0 auto;display:grid;gap:14px}
    .admin-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .admin-list{margin-top:16px;border-top:1px dashed var(--border);padding-top:12px}
    .thumb{width:80px;height:60px;object-fit:cover;border:1px solid var(--border);border-radius:8px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left}
    th{background:var(--background)}
    @media (max-width:768px){.main-content{grid-template-columns:1fr}.game-options{grid-template-columns:1fr}nav ul{flex-wrap:wrap;justify-content:center}.admin-row{grid-template-columns:1fr}}
  </style>
</head>
<body class="light-theme">
  <div class="container">
    <header>
      <div class="logo">Tebak Gambar</div>
      <nav>
        <ul>
          <li><a href="#" class="nav-link active" data-page="home">Home</a></li>
          <li><a href="#" class="nav-link" data-page="levels">Level</a></li>
          <li><a href="#" class="nav-link" data-page="top-score">Top Score</a></li>
          <li><a href="#" class="nav-link" data-page="admin">Admin</a></li>
          <li><a href="#" class="nav-link" id="logout-btn">Logout</a></li>
        </ul>
      </nav>
    </header>

    <div class="main-content">
      <aside class="sidebar">
        <div class="user-info">
          <div class="avatar"><img src="static/avatar/domba.jpg" alt="Avatar" id="user-avatar"></div>
          <div class="username" id="username">Guest</div>
          <div class="user-score">Skor: <span id="user-score">0</span></div>
        </div>

        <div class="theme-selector">
          <h3>Pilih Tema</h3>
          <div class="theme-options">
            <button class="theme-btn active" data-theme="light1">Terang 1</button>
            <button class="theme-btn" data-theme="light2">Terang 2</button>
            <button class="theme-btn" data-theme="light3">Terang 3</button>
            <button class="theme-btn" data-theme="light4">Terang 4</button>
            <button class="theme-btn" data-theme="dark1">Gelap 1</button>
            <button class="theme-btn" data-theme="dark2">Gelap 2</button>
            <button class="theme-btn" data-theme="dark3">Gelap 3</button>
            <button class="theme-btn" data-theme="dark4">Gelap 4</button>
          </div>
        </div>
      </aside>

      <main class="content">
        <!-- HALAMAN HOME -->
        <div class="page active" id="home">
          <div class="login-form">
            <h2>Login Pemain</h2>
            <div class="form-group">
              <label for="player-name">Nama Pemain</label>
              <input type="text" id="player-name" placeholder="Masukkan nama Anda">
            </div>

            <h3>Pilih Avatar</h3>
            <div class="avatar-options">
              <div class="avatar-grid" style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:20px 0;">
                <img src="static/avatar/domba.jpg"  class="avatar-option" data-avatar="domba"  style="width:70px;height:70px;border-radius:50%;border:2px solid #ddd;cursor:pointer;">
                <img src="static/avatar/bebek.jpg"  class="avatar-option" data-avatar="bebek"  style="width:70px;height:70px;border-radius:50%;border:2px solid #ddd;cursor:pointer;">
                <img src="static/avatar/koala.jpg"  class="avatar-option" data-avatar="koala"  style="width:70px;height:70px;border-radius:50%;border:2px solid #ddd;cursor:pointer;">
                <img src="static/avatar/cat.jpg"    class="avatar-option" data-avatar="cat"    style="width:70px;height:70px;border-radius:50%;border:2px solid #ddd;cursor:pointer;">
                <img src="static/avatar/babi.jpg"   class="avatar-option" data-avatar="babi"   style="width:70px;height:70px;border-radius:50%;border:2px solid #ddd;cursor:pointer;">
                <img src="static/avatar/bear.jpg"   class="avatar-option" data-avatar="bear"   style="width:70px;height:70px;border-radius:50%;border:2px solid #ddd;cursor:pointer;">
                <img src="static/avatar/kelinci.jpg"class="avatar-option" data-avatar="kelinci"style="width:70px;height:70px;border-radius:50%;border:2px solid #ddd;cursor:pointer;">
                <img src="static/avatar/kodok.jpg"  class="avatar-option" data-avatar="kodok"  style="width:70px;height:70px;border-radius:50%;border:2px solid #ddd;cursor:pointer;">
              </div>
            </div>

            <button class="btn btn-primary btn-block" id="start-btn">Mulai Bermain</button>
          </div>
        </div>

        <!-- HALAMAN LEVEL -->
        <div class="page" id="levels">
          <div class="level-select">
            <h2>Pilih Level</h2>
            <div class="levels-grid" id="levels-grid"></div>
          </div>
        </div>

        <!-- HALAMAN GAME -->
        <div class="page" id="game">
          <div class="game-container">
            <div class="game-header">
              <div class="level-info">Level <span id="current-level">1</span></div>
              <div class="score-info">Skor: <span id="current-score">0</span></div>
            </div>

            <div class="game-image"><img id="game-img" src="" alt="Gambar tebakan"></div>

            <!-- Kontainer opsi / input -->
            <div class="game-options" id="options-container"></div>

            <div class="game-feedback" id="feedback"></div>

            <div class="game-controls">
              <button class="btn btn-secondary" id="hint-btn">Bantuan</button>
              <button class="btn btn-secondary" id="save-score-btn">Simpan Skor</button>
              <button class="btn btn-primary" id="next-btn" style="display:none;">Lanjut</button>
            </div>
          </div>
        </div>

        <!-- HALAMAN TOP SCORE -->
        <div class="page" id="top-score">
          <h2>Top Score</h2>
          <div id="scoreboard"></div>
        </div>

        <!-- HALAMAN ADMIN -->
        <div class="page" id="admin">
          <h2>Panel Admin</h2>
          <div id="admin-locked" class="admin-box">
            <p>Masukkan password admin untuk mengelola soal.</p>
            <div class="admin-row">
              <input id="admin-pass" type="password" placeholder="Password admin">
              <button class="btn btn-primary" id="admin-login-btn">Login</button>
            </div>
            <small>Hint: 6 digit 😊</small>
          </div>

          <div id="admin-panel" class="admin-box" style="display:none">
            <div class="admin-row">
              <div class="form-group">
                <label>Level</label>
                <input id="adm-level" type="number" min="1" max="100" value="1">
              </div>
              <div class="form-group">
                <label>Mode Soal</label>
                <select id="adm-mode">
                  <option value="easy">Easy (isian)</option>
                  <option value="mcq">MCQ (pilihan ganda)</option>
                </select>
              </div>
            </div>

            <div class="form-group">
              <label>Gambar Soal (upload)</label>
              <input id="adm-image" type="file" accept="image/*">
              <div style="margin-top:8px"><img id="adm-preview" class="thumb" alt="preview" /></div>
            </div>

            <div class="form-group">
              <label>Jawaban Benar</label>
              <input id="adm-correct" type="text" placeholder="contoh: Matahari">
            </div>

            <div id="adm-mcq" class="admin-row">
              <div class="form-group"><label>Opsi Salah A</label><input id="adm-wa" type="text" placeholder="opsi salah A"></div>
              <div class="form-group"><label>Opsi Salah B</label><input id="adm-wb" type="text" placeholder="opsi salah B"></div>
              <div class="form-group"><label>Opsi Salah C</label><input id="adm-wc" type="text" placeholder="opsi salah C"></div>
            </div>

            <div class="admin-row">
              <button class="btn btn-primary" id="adm-save">Simpan / Update Level</button>
              <button class="btn btn-secondary" id="adm-delete">Hapus Custom Level</button>
            </div>

            <div class="admin-row">
              <button class="btn btn-secondary" id="adm-reset-score">Reset Semua Skor</button>
              <button class="btn btn-secondary" id="adm-reset-progress">Reset Progress Pemain</button>
            </div>

            <div class="admin-list" id="adm-list"></div>
          </div>
        </div>
      </main>
    </div>

    <footer><p>&copy; 2025 Game Tebak Gambar. All rights reserved.</p></footer>
  </div>

  <script>
    // --------------------------
    // KONST & UTIL
    // --------------------------
    const LS_KEYS = {
      progress: 'tebakGambarProgress',
      scores: 'tebakGambarScores',
      custom: 'tebakGambarCustomLevels',
      admin: 'tebakGambarAdminAuthed'
    };
    const ADMIN_PASSWORD = '281105';
    const GLOBAL_DEFAULT_MODE = 'easy'; // default global: easy (isian)

    function $(sel){ return document.querySelector(sel); }
    function htmlescape(s){ return (s||'').toString().replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    const norm = s => (s||'').toString().trim().toLowerCase();

    // --------------------------
    // DATA LEVEL DEFAULT (static/level)
    // --------------------------
    let gameData = [];
    for(let i=1;i<=100;i++){
      gameData.push({
        level: i,
        image: `static/level/level${i}.png`,
        correctAnswer: `Jawaban Level ${i}`,
        options: [
          `Jawaban Level ${i}`,
          `Opsi Salah A ${i}`,
          `Opsi Salah B ${i}`,
          `Opsi Salah C ${i}`
        ],
        mode: GLOBAL_DEFAULT_MODE
      });
    }

    // --------------------------
    // THEME
    // --------------------------
    const themes = {
      light1:{primary:"#3498db",secondary:"#2ecc71",accent:"#e74c3c",text:"#2c3e50",background:"#f8f9fa",cardBg:"#ffffff",border:"#ddd"},
      light2:{primary:"#9b59b6",secondary:"#1abc9c",accent:"#e67e22",text:"#34495e",background:"#ecf0f1",cardBg:"#ffffff",border:"#bdc3c7"},
      light3:{primary:"#e74c3c",secondary:"#f1c40f",accent:"#9b59b6",text:"#2c3e50",background:"#fef9e7",cardBg:"#ffffff",border:"#f9e79f"},
      light4:{primary:"#2c3e50",secondary:"#16a085",accent:"#c0392b",text:"#2c3e50",background:"#f5f5f5",cardBg:"#ffffff",border:"#ddd"},
      dark1:{primary:"#2980b9",secondary:"#27ae60",accent:"#c0392b",text:"#ecf0f1",background:"#1a1a2e",cardBg:"#16213e",border:"#34495e"},
      dark2:{primary:"#8e44ad",secondary:"#16a085",accent:"#d35400",text:"#ecf0f1",background:"#2c2c54",cardBg:"#40407a",border:"#706fd3"},
      dark3:{primary:"#e74c3c",secondary:"#f39c12",accent:"#9b59b6",text:"#ecf0f1",background:"#2d3436",cardBg:"#636e72",border:"#b2bec3"},
      dark4:{primary:"#2c3e50",secondary:"#1abc9c",accent:"#e74c3c",text:"#ecf0f1",background:"#0c2461",cardBg:"#1e3799",border:"#4a69bd"}
    };

    // --------------------------
    // STATE
    // --------------------------
    let currentLevel = 1, score = 0, maxUnlockedLevel = 1;
    let playerName = "Guest", playerAvatar = "domba", currentTheme = "light1";

    // DOM refs
    const usernameEl = $('#username');
    const userScoreEl = $('#user-score');
    const userAvatarEl = $('#user-avatar');
    const playerNameInput = $('#player-name');
    const startBtn = $('#start-btn');
    const levelsGrid = $('#levels-grid');
    const currentLevelEl = $('#current-level');
    const currentScoreEl = $('#current-score');
    const gameImg = $('#game-img');
    const optionsContainer = $('#options-container');
    const feedbackEl = $('#feedback');
    const nextBtn = $('#next-btn');
    const hintBtn = $('#hint-btn');
    const saveScoreBtn = $('#save-score-btn');
    const logoutBtn = $('#logout-btn');
    const navLinks = document.querySelectorAll('.nav-link');
    const pages = document.querySelectorAll('.page');
    const themeBtns = document.querySelectorAll('.theme-btn');
    const avatarOptions = document.querySelectorAll('.avatar-option');

    // Admin DOM
    const adminLocked = $('#admin-locked');
    const adminPanel = $('#admin-panel');
    const adminLoginBtn = $('#admin-login-btn');
    const adminPass = $('#admin-pass');
    const admLevel = $('#adm-level');
    const admMode = $('#adm-mode');
    const admImage = $('#adm-image');
    const admPreview = $('#adm-preview');
    const admCorrect = $('#adm-correct');
    const admWA = $('#adm-wa');
    const admWB = $('#adm-wb');
    const admWC = $('#adm-wc');
    const admSave = $('#adm-save');
    const admDelete = $('#adm-delete');
    const admResetScore = $('#adm-reset-score');
    const admResetProgress = $('#adm-reset-progress');
    const admList = $('#adm-list');
    const admMCQWrap = $('#adm-mcq');

    // --------------------------
    // INIT
    // --------------------------
    document.addEventListener('DOMContentLoaded', () => {
      loadCustomLevels();
      generateLevelButtons();
      loadGameProgress();
      updateUI();
      renderScoreboard();
      updateAdminGate();
    });

    // --------------------------
    // LEVEL BUTTONS
    // --------------------------
    function generateLevelButtons(){
      levelsGrid.innerHTML = '';
      for(let i=1;i<=100;i++){
        const b = document.createElement('button');
        b.className = 'level-btn';
        b.textContent = i;
        b.dataset.level = i;

        if(i === currentLevel) b.classList.add('current');
        else if(i < currentLevel) b.classList.add('completed');
        else if(i === maxUnlockedLevel) b.classList.add('unlocked');

        if(i <= maxUnlockedLevel){
          b.addEventListener('click',()=>selectLevel(i));
        }
        levelsGrid.appendChild(b);
      }
    }
    function selectLevel(level){ currentLevel = level; showPage('game'); loadLevel(level); }

    // --------------------------
    // LOAD LEVEL
    // --------------------------
    function getLevelData(level){
      return gameData[level-1];
    }
    function loadLevel(level){
      const d = getLevelData(level);
      currentLevelEl.textContent = level;
      currentScoreEl.textContent = score;

      // gambar: pakai custom->dataURL jika ada; else pakai static/level/levelN.png; fallback placeholder
      const fromCustom = (d.customImage && d.customImage.startsWith('data:'));
      gameImg.onerror = () => {
        gameImg.onerror = null;
        gameImg.src = `https://via.placeholder.com/500x300/3498db/ffffff?text=Level+${level}`;
      };
      gameImg.src = (fromCustom ? d.customImage : (d.image + `?v=${Date.now()}`));
      gameImg.alt = `Gambar untuk level ${level}`;

      // render soal: easy (isian) atau mcq (pilihan ganda)
      optionsContainer.innerHTML = '';
      if ((d.mode || GLOBAL_DEFAULT_MODE) === 'easy') {
        renderEasy(d);
      } else {
        renderMCQ(d);
      }

      feedbackEl.textContent = '';
      feedbackEl.className = 'game-feedback';
      nextBtn.style.display = 'none';
    }

    function renderMCQ(d){
      const shuffled = [...d.options];
      shuffled.sort(()=>Math.random()-0.5);
      optionsContainer.classList.add('game-options');
      optionsContainer.innerHTML = '';
      shuffled.forEach(opt=>{
        const btn = document.createElement('button');
        btn.className = 'option-btn';
        btn.textContent = opt;
        btn.onclick = ()=>checkAnswer(opt, d.correctAnswer);
        optionsContainer.appendChild(btn);
      });
    }

    function renderEasy(d){
      optionsContainer.classList.remove('game-options');
      optionsContainer.innerHTML = `
        <div style="display:grid;gap:12px;max-width:520px;margin:0 auto;">
          <input id="easy-input" type="text" placeholder="Ketik jawaban kamu…" 
                 style="padding:12px 15px;border:2px solid var(--border);border-radius:10px;background:var(--background);color:var(--text);font-size:1rem;">
          <button id="easy-submit" class="btn btn-primary">Cek Jawaban</button>
        </div>`;
      const input = $('#easy-input'); const submit = $('#easy-submit');
      const go = ()=>checkTextAnswer(input.value, d.correctAnswer);
      submit.onclick = go; input.onkeydown = e=>{if(e.key==='Enter') go();};
    }

    function checkAnswer(selected, correct){
      document.querySelectorAll('.option-btn').forEach(b=>{
        b.disabled = true;
        if(b.textContent === correct) b.classList.add('correct');
        else if(b.textContent === selected && selected !== correct) b.classList.add('incorrect');
      });
      postAnswer(selected === correct, correct);
    }

    function checkTextAnswer(text, correct){
      postAnswer(norm(text) === norm(correct), correct);
    }

    function postAnswer(ok, correct){
      if(ok){
        feedbackEl.textContent = "Benar! 🎉";
        feedbackEl.classList.remove('incorrect-feedback');
        feedbackEl.classList.add('correct-feedback');
        score += 10;
        userScoreEl.textContent = score;
        currentScoreEl.textContent = score;
        if(currentLevel === maxUnlockedLevel){ maxUnlockedLevel = Math.min(maxUnlockedLevel+1, 100); }
        saveGameProgress();
      }else{
        feedbackEl.textContent = `Salah! Jawaban yang benar: ${correct}`;
        feedbackEl.classList.remove('correct-feedback');
        feedbackEl.classList.add('incorrect-feedback');
      }
      nextBtn.style.display = 'block';
    }

    // --------------------------
    // SCOREBOARD
    // --------------------------
    function getScores(){
      try{ return JSON.parse(localStorage.getItem(LS_KEYS.scores) || '[]'); }catch{ return []; }
    }
    function setScores(arr){ localStorage.setItem(LS_KEYS.scores, JSON.stringify(arr)); }
    function addScore(name, score, avatar){
      const scores = getScores();
      scores.push({name, score, avatar, date: new Date().toISOString()});
      scores.sort((a,b)=> b.score - a.score);
      setScores(scores.slice(0,50)); // simpan top 50
      renderScoreboard();
    }
    function renderScoreboard(){
      const scores = getScores();
      const el = $('#scoreboard');
      if(!scores.length){ el.innerHTML = '<p>Belum ada skor tersimpan.</p>'; return; }
      const rows = scores.map((s,idx)=>`
        <tr>
          <td>${idx+1}</td>
          <td><img src="static/avatar/${htmlescape(s.avatar||'domba')}.jpg" onerror="this.src='static/avatar/${htmlescape(s.avatar||'domba')}.png'" style="width:28px;height:28px;border-radius:50%;vertical-align:middle;margin-right:6px"> ${htmlescape(s.name)}</td>
          <td>${s.score}</td>
          <td>${new Date(s.date).toLocaleString()}</td>
        </tr>`).join('');
      el.innerHTML = `<table><thead><tr><th>#</th><th>Pemain</th><th>Skor</th><th>Waktu</th></tr></thead><tbody>${rows}</tbody></table>`;
    }

    // --------------------------
    // STORAGE (PROGRESS)
    // --------------------------
    function saveGameProgress(){
      const data = {playerName, playerAvatar, score, currentLevel, maxUnlockedLevel, currentTheme};
      localStorage.setItem(LS_KEYS.progress, JSON.stringify(data));
    }
    function loadGameProgress(){
      const saved = localStorage.getItem(LS_KEYS.progress);
      if(!saved) return;
      try{
        const p = JSON.parse(saved);
        playerName = p.playerName || playerName;
        if(p.playerAvatar && /^avatar\d+$/i.test(p.playerAvatar)) playerAvatar = "domba";
        else playerAvatar = p.playerAvatar || playerAvatar;
        score = p.score ?? score;
        currentLevel = p.currentLevel ?? currentLevel;
        maxUnlockedLevel = p.maxUnlockedLevel ?? maxUnlockedLevel;
        currentTheme = p.currentTheme || 'light1';
        applyTheme(currentTheme);
        themeBtns.forEach(btn=> btn.classList.toggle('active', btn.dataset.theme === currentTheme));
      }catch{}
    }

    // --------------------------
    // CUSTOM LEVELS (ADMIN)
    // --------------------------
    function loadCustomLevels(){
      try{
        const obj = JSON.parse(localStorage.getItem(LS_KEYS.custom) || '{}');
        Object.keys(obj).forEach(k=>{
          const n = Number(k); if(!n || n<1 || n>100) return;
          const d = gameData[n-1];
          const c = obj[k];
          d.customImage = c.image || null;
          d.correctAnswer = c.correct || d.correctAnswer;
          d.options = c.options && c.options.length === 4 ? c.options : d.options;
          d.mode = c.mode || d.mode;
        });
      }catch{}
    }
    function saveCustomLevel(n, payload){
      const obj = JSON.parse(localStorage.getItem(LS_KEYS.custom) || '{}');
      obj[n] = payload;
      localStorage.setItem(LS_KEYS.custom, JSON.stringify(obj));
      loadCustomLevels();
      renderAdminList();
    }
    function deleteCustomLevel(n){
      const obj = JSON.parse(localStorage.getItem(LS_KEYS.custom) || '{}');
      delete obj[n];
      localStorage.setItem(LS_KEYS.custom, JSON.stringify(obj));
      loadCustomLevels();
      renderAdminList();
    }
    function renderAdminList(){
      const obj = JSON.parse(localStorage.getItem(LS_KEYS.custom) || '{}');
      const keys = Object.keys(obj).sort((a,b)=>Number(a)-Number(b));
      if(!keys.length){ admList.innerHTML = '<p>Belum ada custom level.</p>'; return; }
      admList.innerHTML = keys.map(k=>{
        const c = obj[k];
        return `<div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
          <img class="thumb" src="${c.image || ''}" alt="L${k}">
          <div>
            <div><b>Level ${k}</b> • Mode: ${c.mode || 'easy'}</div>
            <div>Jawaban: ${htmlescape(c.correct||'')}</div>
            ${c.mode==='mcq' ? `<div>Opsi: ${c.options.map(htmlescape).join(' | ')}</div>` : ''}
          </div>
        </div>`;
      }).join('');
    }

    // --------------------------
    // UI
    // --------------------------
    function updateUI(){
      usernameEl.textContent = playerName;
      userScoreEl.textContent = score;
      // avatar: coba jpg -> fallback png
      userAvatarEl.onerror = ()=>{ userAvatarEl.onerror=null; userAvatarEl.src=`static/avatar/${playerAvatar}.png`; };
      userAvatarEl.src = `static/avatar/${playerAvatar}.jpg`;
      playerNameInput.value = playerName;
      avatarOptions.forEach(a=> a.style.borderColor = (a.dataset.avatar === playerAvatar) ? '#3498db' : '#ddd' );
      generateLevelButtons();
    }
    function showPage(id){
      pages.forEach(p=>p.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      navLinks.forEach(l=> l.classList.toggle('active', l.dataset.page===id));
      if(id==='top-score') renderScoreboard();
      if(id==='admin') updateAdminGate();
    }
    function applyTheme(name){
      const t = themes[name]; Object.entries(t).forEach(([k,v])=> document.documentElement.style.setProperty(`--${k}`, v));
      if(name.startsWith('dark')) document.body.classList.add('dark-theme'); else document.body.classList.remove('dark-theme');
      currentTheme = name; saveGameProgress();
    }
    function updateAdminGate(){
      const authed = localStorage.getItem(LS_KEYS.admin)==='1';
      adminLocked.style.display = authed ? 'none' : 'block';
      adminPanel.style.display = authed ? 'block' : 'none';
      if(authed) renderAdminList();
    }

    // --------------------------
    // EVENTS
    // --------------------------
    startBtn.addEventListener('click',()=>{ playerName = playerNameInput.value.trim() || 'Player'; updateUI(); showPage('levels'); });
    nextBtn.addEventListener('click',()=>{ if(currentLevel < 100) selectLevel(currentLevel+1); else showPage('levels'); });
    hintBtn.addEventListener('click',()=>{
      const d = getLevelData(currentLevel);
      const hint = (d.correctAnswer||'').slice(0,1) + '…';
      alert(`Hint: ${hint}`);
    });
    saveScoreBtn.addEventListener('click',()=>{ addScore(playerName, score, playerAvatar); alert('Skor disimpan! Cek halaman Top Score.'); });

    logoutBtn.addEventListener('click',()=> showPage('home'));

    navLinks.forEach(link=> link.addEventListener('click',e=>{ e.preventDefault(); showPage(link.dataset.page); }));

    themeBtns.forEach(btn=> btn.addEventListener('click',()=>{
      themeBtns.forEach(b=>b.classList.remove('active')); btn.classList.add('active'); applyTheme(btn.dataset.theme);
    }));

    avatarOptions.forEach(img=> img.addEventListener('click',()=>{
      playerAvatar = img.dataset.avatar;
      userAvatarEl.onerror = ()=>{ userAvatarEl.onerror=null; userAvatarEl.src=`static/avatar/${playerAvatar}.png`; };
      userAvatarEl.src = `static/avatar/${playerAvatar}.jpg`;
      avatarOptions.forEach(a=> a.style.borderColor = (a===img) ? '#3498db' : '#ddd');
      saveGameProgress();
    }));

    // Admin login
    adminLoginBtn.addEventListener('click',()=>{
      if(adminPass.value === ADMIN_PASSWORD){ localStorage.setItem(LS_KEYS.admin,'1'); adminPass.value=''; updateAdminGate(); }
      else alert('Password salah.');
    });

    // Admin mode switch -> tampil/ sembunyi opsi MCQ
    admMode.addEventListener('change',()=>{ admMCQWrap.style.display = (admMode.value==='mcq') ? 'grid' : 'none'; });

    // Preview image saat upload
    admImage.addEventListener('change',()=>{
      const f = admImage.files && admImage.files[0];
      if(!f) return; const r = new FileReader();
      r.onload = e=> { admPreview.src = e.target.result; };
      r.readAsDataURL(f);
    });

    // Simpan/Update custom level
    admSave.addEventListener('click',()=>{
      const n = Math.max(1, Math.min(100, parseInt(admLevel.value||'1',10)));
      const payload = {
        mode: admMode.value || 'easy',
        correct: admCorrect.value.trim()
      };
      if(payload.mode==='mcq'){
        const opts = [payload.correct, admWA.value.trim(), admWB.value.trim(), admWC.value.trim()].filter(Boolean);
        while(opts.length < 4) opts.push('—');
        payload.options = opts.slice(0,4);
      }
      if(admPreview.src && admPreview.src.startsWith('data:')) payload.image = admPreview.src;

      saveCustomLevel(n, payload);

      // sinkron ke gameData sekarang juga
      const d = gameData[n-1];
      if(payload.image) d.customImage = payload.image;
      if(payload.correct) d.correctAnswer = payload.correct;
      if(payload.options) d.options = payload.options;
      if(payload.mode) d.mode = payload.mode;

      alert(`Level ${n} disimpan!`);
      admPreview.src = ''; admImage.value=''; // clear preview
    });

    // Hapus custom level
    admDelete.addEventListener('click',()=>{
      const n = Math.max(1, Math.min(100, parseInt(admLevel.value||'1',10)));
      deleteCustomLevel(n);
      const d = gameData[n-1];
      d.customImage = null; d.mode = GLOBAL_DEFAULT_MODE; // reset ke default
      alert(`Custom Level ${n} dihapus (kembali ke file static).`);
    });

    // Reset skor & progress
    admResetScore.addEventListener('click',()=>{ if(confirm('Hapus semua skor?')){ localStorage.removeItem(LS_KEYS.scores); renderScoreboard(); alert('Skor di-reset.'); }});
    admResetProgress.addEventListener('click',()=>{ if(confirm('Hapus progress pemain?')){ localStorage.removeItem(LS_KEYS.progress); score=0; currentLevel=1; maxUnlockedLevel=1; updateUI(); alert('Progress di-reset.'); }});
  </script>
</body>
</html>
