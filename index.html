<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Game Tebak Gambar</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root { --primary:#3498db; --secondary:#2ecc71; --accent:#e74c3c; --text:#2c3e50; --background:#f8f9fa; --card-bg:#ffffff; --border:#ddd; }
    .dark-theme{ --primary:#2980b9; --secondary:#27ae60; --accent:#c0392b; --text:#ecf0f1; --background:#1a1a2e; --card-bg:#16213e; --border:#34495e; }
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;transition:background-color .3s,color .3s}
    body{background-color:var(--background);color:var(--text);min-height:100vh;padding:20px}
    .container{max-width:1200px;margin:0 auto}
    header{display:flex;justify-content:space-between;align-items:center;padding:15px 0;border-bottom:2px solid var(--primary);margin-bottom:30px}
    .logo{font-size:2rem;font-weight:bold;color:var(--primary)}
    nav ul{display:flex;list-style:none;gap:20px}
    nav a{text-decoration:none;color:var(--text);font-weight:500;padding:8px 15px;border-radius:20px;transition:all .3s}
    nav a:hover,nav a.active{background-color:var(--primary);color:#fff}
    .main-content{display:grid;grid-template-columns:1fr 3fr;gap:30px}
    .sidebar{background-color:var(--card-bg);border-radius:15px;padding:20px;box-shadow:0 5px 15px rgba(0,0,0,.1)}
    .user-info{text-align:center;margin-bottom:30px}
    .avatar{width:100px;height:100px;border-radius:50%;border:3px solid var(--primary);margin:0 auto 15px;overflow:hidden}
    .avatar img{width:100%;height:100%;object-fit:cover}
    .username{font-size:1.2rem;font-weight:bold;margin-bottom:5px}
    .user-score{color:var(--secondary);font-weight:500}
    .theme-selector{margin-bottom:30px}
    .theme-selector h3{margin-bottom:15px;padding-bottom:10px;border-bottom:1px solid var(--border)}
    .theme-options{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .theme-btn{padding:10px;border:2px solid var(--border);border-radius:10px;background:none;cursor:pointer;text-align:center;font-weight:500}
    .theme-btn.active{border-color:var(--primary);background-color:var(--primary);color:#fff}
    .content{background-color:var(--card-bg);border-radius:15px;padding:30px;box-shadow:0 5px 15px rgba(0,0,0,.1)}
    .page{display:none}.page.active{display:block}
    .login-form h2,.level-select h2,.game-container h2{margin-bottom:20px;color:var(--primary);text-align:center}
    .form-group{margin-bottom:20px}
    .form-group label{display:block;margin-bottom:8px;font-weight:500}
    .form-group input,.form-group select{width:100%;padding:12px 15px;border:2px solid var(--border);border-radius:8px;font-size:1rem;background-color:var(--background);color:var(--text)}
    .btn{padding:12px 25px;border:none;border-radius:30px;font-size:1rem;font-weight:600;cursor:pointer;transition:all .3s; pointer-events:auto; touch-action:manipulation;}
    .btn-primary{background-color:var(--primary);color:#fff}
    .btn-primary:hover{background-color:var(--secondary)}
    .btn-secondary{background-color:var(--background);color:var(--text);border:2px solid var(--border)}
    .btn-secondary:hover{background-color:var(--border)}
    .btn-block{display:block;width:100%}
    .levels-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(80px,1fr));gap:15px;margin-top:30px}
    .level-btn{aspect-ratio:1;border-radius:10px;border:2px solid var(--border);background-color:var(--background);color:var(--text);font-size:1.2rem;font-weight:bold;cursor:pointer;transition:all .3s}
    .level-btn.unlocked{border-color:var(--secondary);background-color:rgba(46,204,113,.1)}
    .level-btn.current{border-color:var(--primary);background-color:var(--primary);color:#fff}
    .level-btn.completed{border-color:var(--secondary);background-color:var(--secondary);color:#fff}
    .game-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;padding-bottom:15px;border-bottom:1px solid var(--border)}
    .game-image{width:100%;max-width:500px;height:300px;margin:0 auto 30px;border:3px dashed var(--primary);border-radius:10px;display:flex;align-items:center;justify-content:center;overflow:hidden}
    .game-image img{max-width:100%;max-height:100%;object-fit:contain}
    .game-options{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:30px}
    .option-btn{padding:15px;border:2px solid var(--border);border-radius:10px;background:none;color:var(--text);font-size:1rem;font-weight:500;cursor:pointer;transition:all .3s}
    .option-btn:hover{border-color:var(--primary);background-color:rgba(52,152,219,.1)}
    .option-btn.correct{border-color:var(--secondary);background-color:rgba(46,204,113,.2)}
    .option-btn.incorrect{border-color:var(--accent);background-color:rgba(231,76,60,.2)}
    .game-feedback{text-align:center;font-size:1.2rem;font-weight:bold;margin-bottom:20px;min-height:40px}
    .correct-feedback{color:var(--secondary)} .incorrect-feedback{color:var(--accent)}
    .game-controls{display:flex;justify-content:center;gap:12px;flex-wrap:wrap}
    footer{text-align:center;margin-top:50px;padding-top:20px;border-top:1px solid var(--border);color:var(--text);font-size:.9rem}
    .admin-box{max-width:720px;margin:0 auto;display:grid;gap:14px}
    .admin-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .admin-list{margin-top:16px;border-top:1px dashed var(--border);padding-top:12px}
    .thumb{width:80px;height:60px;object-fit:cover;border:1px solid var(--border);border-radius:8px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left}
    th{background:var(--background)}
    @media (max-width:768px){.main-content{grid-template-columns:1fr}.game-options{grid-template-columns:1fr}nav ul{flex-wrap:wrap;justify-content:center}.admin-row{grid-template-columns:1fr}}
  </style>
</head>
<body class="light-theme">
  <div class="container">
    <header>
      <div class="logo">Tebak Gambar</div>
      <nav>
        <ul>
          <li><a href="#" class="nav-link active" data-page="home">Home</a></li>
          <li><a href="#" class="nav-link" data-page="levels">Level</a></li>
          <li><a href="#" class="nav-link" data-page="top-score">Top Score</a></li>
          <li><a href="#" class="nav-link" data-page="admin">Admin</a></li>
          <li><a href="#" class="nav-link" id="logout-btn">Logout</a></li>
        </ul>
      </nav>
    </header>

    <div class="main-content">
      <aside class="sidebar">
        <div class="user-info">
          <div class="avatar"><img src="static/avatar/domba.jpg" alt="Avatar" id="user-avatar"></div>
          <div class="username" id="username">Guest</div>
          <div class="user-score">Skor: <span id="user-score">0</span></div>
        </div>

        <div class="theme-selector">
          <h3>Pilih Tema</h3>
          <div class="theme-options">
            <button class="theme-btn active" data-theme="light1">Terang 1</button>
            <button class="theme-btn" data-theme="light2">Terang 2</button>
            <button class="theme-btn" data-theme="light3">Terang 3</button>
            <button class="theme-btn" data-theme="light4">Terang 4</button>
            <button class="theme-btn" data-theme="dark1">Gelap 1</button>
            <button class="theme-btn" data-theme="dark2">Gelap 2</button>
            <button class="theme-btn" data-theme="dark3">Gelap 3</button>
            <button class="theme-btn" data-theme="dark4">Gelap 4</button>
          </div>
        </div>
      </aside>

      <main class="content">
        <!-- HOME -->
        <div class="page active" id="home">
          <div class="login-form">
            <h2>Login Pemain</h2>
            <div class="form-group">
              <label for="player-name">Nama Pemain</label>
              <input type="text" id="player-name" placeholder="Masukkan nama Anda">
            </div>

            <h3>Pilih Avatar</h3>
            <div class="avatar-options">
              <div class="avatar-grid" style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:20px 0;">
                <img src="static/avatar/domba.jpg"  class="avatar-option" data-avatar="domba"  style="width:70px;height:70px;border-radius:50%;border:2px solid #ddd;cursor:pointer;">
                <img src="static/avatar/bebek.jpg"  class="avatar-option" data-avatar="bebek"  style="width:70px;height:70px;border-radius:50%;border:2px solid #ddd;cursor:pointer;">
                <img src="static/avatar/koala.jpg"  class="avatar-option" data-avatar="koala"  style="width:70px;height:70px;border-radius:50%;border:2px solid #ddd;cursor:pointer;">
                <img src="static/avatar/cat.jpg"    class="avatar-option" data-avatar="cat"    style="width:70px;height:70px;border-radius:50%;border:2px solid #ddd;cursor:pointer;">
                <img src="static/avatar/babi.jpg"   class="avatar-option" data-avatar="babi"   style="width:70px;height:70px;border-radius:50%;border:2px solid #ddd;cursor:pointer;">
                <img src="static/avatar/bear.jpg"   class="avatar-option" data-avatar="bear"   style="width:70px;height:70px;border-radius:50%;border:2px solid #ddd;cursor:pointer;">
                <img src="static/avatar/kelinci.jpg"class="avatar-option" data-avatar="kelinci"style="width:70px;height:70px;border-radius:50%;border:2px solid #ddd;cursor:pointer;">
                <img src="static/avatar/kodok.jpg"  class="avatar-option" data-avatar="kodok"  style="width:70px;height:70px;border-radius:50%;border:2px solid #ddd;cursor:pointer;">
              </div>
            </div>

            <button class="btn btn-primary btn-block" id="start-btn" type="button">Mulai Bermain</button>
          </div>
        </div>

        <!-- LEVELS -->
        <div class="page" id="levels">
          <div class="level-select">
            <h2>Pilih Level</h2>
            <div class="levels-grid" id="levels-grid"></div>
          </div>
        </div>

        <!-- GAME -->
        <div class="page" id="game">
          <div class="game-container">
            <div class="game-header">
              <div class="level-info">Level <span id="current-level">1</span></div>
              <div class="score-info">Skor: <span id="current-score">0</span></div>
            </div>

            <div class="game-image"><img id="game-img" src="" alt="Gambar tebakan"></div>

            <div class="game-options" id="options-container"></div>

            <div class="game-feedback" id="feedback"></div>

            <div class="game-controls">
              <button class="btn btn-secondary" id="hint-btn" type="button">Bantuan</button>
              <button class="btn btn-secondary" id="save-score-btn" type="button">Simpan Skor</button>
              <button class="btn btn-primary" id="next-btn" type="button" style="display:none;">Lanjut</button>
            </div>
          </div>
        </div>

        <!-- TOP SCORE -->
        <div class="page" id="top-score">
          <h2>Top Score</h2>
          <div id="scoreboard"></div>
        </div>

        <!-- ADMIN -->
        <div class="page" id="admin">
          <h2>Panel Admin</h2>
          <div id="admin-locked" class="admin-box">
            <p>Masukkan password admin untuk mengelola soal.</p>
            <div class="admin-row">
              <input id="admin-pass" type="password" placeholder="Password admin">
              <button class="btn btn-primary" id="admin-login-btn" type="button">Login</button>
            </div>
            <small>Hint: 6 digit ðŸ˜Š</small>
          </div>

          <div id="admin-panel" class="admin-box" style="display:none">
            <div class="admin-row">
              <div class="form-group">
                <label>Level</label>
                <input id="adm-level" type="number" min="1" max="100" value="1">
              </div>
              <div class="form-group">
                <label>Mode Soal</label>
                <select id="adm-mode">
                  <option value="easy">Easy (isian)</option>
                  <option value="mcq">MCQ (pilihan ganda)</option>
                </select>
              </div>
            </div>

            <div class="form-group">
              <label>Gambar Soal (upload)</label>
              <input id="adm-image" type="file" accept="image/*">
              <div style="margin-top:8px"><img id="adm-preview" class="thumb" alt="preview" /></div>
            </div>

            <div class="form-group">
              <label>Jawaban Benar</label>
              <input id="adm-correct" type="text" placeholder="contoh: Matahari">
            </div>

            <div id="adm-mcq" class="admin-row">
              <div class="form-group"><label>Opsi Salah A</label><input id="adm-wa" type="text" placeholder="opsi salah A"></div>
              <div class="form-group"><label>Opsi Salah B</label><input id="adm-wb" type="text" placeholder="opsi salah B"></div>
              <div class="form-group"><label>Opsi Salah C</label><input id="adm-wc" type="text" placeholder="opsi salah C"></div>
            </div>

            <div class="admin-row">
              <button class="btn btn-primary"  id="adm-save" type="button">Simpan / Update Level</button>
              <button class="btn btn-secondary" id="adm-delete" type="button">Hapus Custom Level</button>
            </div>

            <div class="admin-row">
              <button class="btn btn-secondary" id="adm-reset-score" type="button">Reset Semua Skor</button>
              <button class="btn btn-secondary" id="adm-reset-progress" type="button">Reset Progress Pemain</button>
            </div>

            <div class="admin-list" id="adm-list"></div>
          </div>
        </div>
      </main>
    </div>

    <footer><p>&copy; 2025 Game Tebak Gambar. All rights reserved.</p></footer>
  </div>

  <script>
    // ====== KONST & UTIL ======
    const LS_KEYS = {
      progress: 'tebakGambarProgress',
      scores: 'tebakGambarScores',
      custom: 'tebakGambarCustomLevels',
      admin: 'tebakGambarAdminAuthed'
    };
    const ADMIN_PASSWORD = '281105';
    const GLOBAL_DEFAULT_MODE = 'easy';

    const $ = sel => document.querySelector(sel);
    const htmlescape = s => (s||'').toString().replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const norm = s => (s||'').toString().trim().toLowerCase();

    // Kompres image -> dataURL JPEG agar muat di localStorage
    async function fileToDataURLCompressed(file, maxW=900, maxH=900, quality=0.8){
      return new Promise((resolve, reject)=>{
        const img = new Image();
        img.onload = ()=>{
          let w=img.width,h=img.height;
          const r = Math.min(maxW/w, maxH/h, 1);
          const cw=Math.round(w*r), ch=Math.round(h*r);
          const cnv=document.createElement('canvas'); cnv.width=cw; cnv.height=ch;
          cnv.getContext('2d').drawImage(img,0,0,cw,ch);
          resolve(cnv.toDataURL('image/jpeg', quality));
        };
        img.onerror = reject;
        const fr = new FileReader();
        fr.onload = e => img.src = e.target.result;
        fr.onerror = reject;
        fr.readAsDataURL(file);
      });
    }

    // ====== DATA LEVEL DEFAULT ======
    let gameData = [];
    for(let i=1;i<=100;i++){
      gameData.push({
        level:i,
        image:`static/level/level${i}.png`,
        correctAnswer:`Jawaban Level ${i}`,
        options:[`Jawaban Level ${i}`,`Opsi Salah A ${i}`,`Opsi Salah B ${i}`,`Opsi Salah C ${i}`],
        mode: GLOBAL_DEFAULT_MODE
      });
    }

    // ====== THEME ======
    const themes = {
      light1:{primary:"#3498db",secondary:"#2ecc71",accent:"#e74c3c",text:"#2c3e50",background:"#f8f9fa",cardBg:"#ffffff",border:"#ddd"},
      light2:{primary:"#9b59b6",secondary:"#1abc9c",accent:"#e67e22",text:"#34495e",background:"#ecf0f1",cardBg:"#ffffff",border:"#bdc3c7"},
      light3:{primary:"#e74c3c",secondary:"#f1c40f",accent:"#9b59b6",text:"#2c3e50",background:"#fef9e7",cardBg:"#ffffff",border:"#f9e79f"},
      light4:{primary:"#2c3e50",secondary:"#16a085",accent:"#c0392b",text:"#2c3e50",background:"#f5f5f5",cardBg:"#ffffff",border:"#ddd"},
      dark1:{primary:"#2980b9",secondary:"#27ae60",accent:"#c0392b",text:"#ecf0f1",background:"#1a1a2e",cardBg:"#16213e",border:"#34495e"},
      dark2:{primary:"#8e44ad",secondary:"#16a085",accent:"#d35400",text:"#ecf0f1",background:"#2c2c54",cardBg:"#40407a",border:"#706fd3"},
      dark3:{primary:"#e74c3c",secondary:"#f39c12",accent:"#9b59b6",text:"#ecf0f1",background:"#2d3436",cardBg:"#636e72",border:"#b2bec3"},
      dark4:{primary:"#2c3e50",secondary:"#1abc9c",accent:"#e74c3c",text:"#ecf0f1",background:"#0c2461",cardBg:"#1e3799",border:"#4a69bd"}
    };

    // ====== STATE ======
    let currentLevel=1, score=0, maxUnlockedLevel=1;
    let playerName="Guest", playerAvatar="domba", currentTheme="light1";

    // DOM refs
    const usernameEl=$('#username'), userScoreEl=$('#user-score'), userAvatarEl=$('#user-avatar');
    const playerNameInput=$('#player-name'), startBtn=$('#start-btn');
    const levelsGrid=$('#levels-grid'), currentLevelEl=$('#current-level'), currentScoreEl=$('#current-score');
    const gameImg=$('#game-img'), optionsContainer=$('#options-container'), feedbackEl=$('#feedback');
    const nextBtn=$('#next-btn'), hintBtn=$('#hint-btn'), saveScoreBtn=$('#save-score-btn'), logoutBtn=$('#logout-btn');
    const navLinks=document.querySelectorAll('.nav-link'), pages=document.querySelectorAll('.page');
    const themeBtns=document.querySelectorAll('.theme-btn'), avatarOptions=document.querySelectorAll('.avatar-option');

    // Admin DOM
    const adminLocked=$('#admin-locked'), adminPanel=$('#admin-panel');
    const adminLoginBtn=$('#admin-login-btn'), adminPass=$('#admin-pass');
    const admLevel=$('#adm-level'), admMode=$('#adm-mode'), admImage=$('#adm-image'), admPreview=$('#adm-preview');
    const admCorrect=$('#adm-correct'), admWA=$('#adm-wa'), admWB=$('#adm-wb'), admWC=$('#adm-wc');
    const admSave=$('#adm-save'), admDelete=$('#adm-delete'), admResetScore=$('#adm-reset-score'), admResetProgress=$('#adm-reset-progress');
    const admList=$('#adm-list'), admMCQWrap=$('#adm-mcq');

    // ====== INIT ======
    document.addEventListener('DOMContentLoaded', ()=>{
      loadCustomLevels();
      generateLevelButtons();
      loadGameProgress();
      updateUI();
      renderScoreboard();
      updateAdminGate();
      admMCQWrap.style.display = (admMode.value==='mcq') ? 'grid' : 'none';
    });

    // ====== LEVEL BUTTONS ======
    function generateLevelButtons(){
      levelsGrid.innerHTML='';
      for(let i=1;i<=100;i++){
        const b=document.createElement('button');
        b.className='level-btn'; b.textContent=i; b.dataset.level=i;
        if(i===currentLevel) b.classList.add('current');
        else if(i<currentLevel) b.classList.add('completed');
        else if(i===maxUnlockedLevel) b.classList.add('unlocked');
        if(i<=maxUnlockedLevel) b.addEventListener('click',()=>selectLevel(i));
        levelsGrid.appendChild(b);
      }
    }
    function selectLevel(l){ currentLevel=l; showPage('game'); loadLevel(l); }

    // ====== LOAD LEVEL ======
    const getLevelData = l => gameData[l-1];
    function loadLevel(l){
      const d=getLevelData(l);
      currentLevelEl.textContent=l; currentScoreEl.textContent=score;

      const fromCustom = (d.customImage && d.customImage.startsWith('data:'));
      gameImg.onerror = ()=>{ gameImg.onerror=null; gameImg.src=`https://via.placeholder.com/500x300/3498db/ffffff?text=Level+${l}`; };
      gameImg.src = fromCustom ? d.customImage : (d.image + `?v=${Date.now()}`);
      gameImg.alt = `Gambar untuk level ${l}`;

      optionsContainer.innerHTML='';
      if((d.mode||GLOBAL_DEFAULT_MODE)==='easy') renderEasy(d); else renderMCQ(d);

      feedbackEl.textContent=''; feedbackEl.className='game-feedback'; nextBtn.style.display='none';
    }

    function renderMCQ(d){
      optionsContainer.classList.add('game-options');
      const opts=[...d.options]; opts.sort(()=>Math.random()-0.5);
      opts.forEach(o=>{
        const btn=document.createElement('button');
        btn.className='option-btn'; btn.textContent=o;
        btn.onclick=()=>checkAnswer(o,d.correctAnswer);
        optionsContainer.appendChild(btn);
      });
    }
    function renderEasy(d){
      optionsContainer.classList.remove('game-options');
      optionsContainer.innerHTML=`
        <div style="display:grid;gap:12px;max-width:520px;margin:0 auto;">
          <input id="easy-input" type="text" placeholder="Ketik jawaban kamuâ€¦" 
            style="padding:12px 15px;border:2px solid var(--border);border-radius:10px;background:var(--background);color:var(--text);font-size:1rem;">
          <button id="easy-submit" class="btn btn-primary" type="button">Cek Jawaban</button>
        </div>`;
      const input=$('#easy-input'), submit=$('#easy-submit');
      const go=()=>checkTextAnswer(input.value,d.correctAnswer);
      submit.onclick=go; input.onkeydown=e=>{ if(e.key==='Enter') go(); };
    }

    function checkAnswer(sel, correct){
      document.querySelectorAll('.option-btn').forEach(b=>{
        b.disabled=true;
        if(b.textContent===correct) b.classList.add('correct');
        else if(b.textContent===sel && sel!==correct) b.classList.add('incorrect');
      });
      postAnswer(sel===correct, correct);
    }
    function checkTextAnswer(txt, correct){ postAnswer(norm(txt)===norm(correct), correct); }
    function postAnswer(ok, correct){
      if(ok){
        feedbackEl.textContent="Benar! ðŸŽ‰";
        feedbackEl.classList.remove('incorrect-feedback'); feedbackEl.classList.add('correct-feedback');
        score+=10; userScoreEl.textContent=score; currentScoreEl.textContent=score;
        if(currentLevel===maxUnlockedLevel) maxUnlockedLevel=Math.min(maxUnlockedLevel+1,100);
        saveGameProgress();
      }else{
        feedbackEl.textContent=`Salah! Jawaban yang benar: ${correct}`;
        feedbackEl.classList.remove('correct-feedback'); feedbackEl.classList.add('incorrect-feedback');
      }
      nextBtn.style.display='block';
    }

    // ====== SCOREBOARD ======
    const getScores=()=>{ try{return JSON.parse(localStorage.getItem(LS_KEYS.scores)||'[]')}catch{return[]} };
    const setScores=a=>localStorage.setItem(LS_KEYS.scores, JSON.stringify(a));
    function addScore(name,score,avatar){
      const s=getScores(); s.push({name,score,avatar,date:new Date().toISOString()});
      s.sort((a,b)=>b.score-a.score); setScores(s.slice(0,50)); renderScoreboard();
    }
    function renderScoreboard(){
      const s=getScores(), el=$('#scoreboard');
      if(!s.length){ el.innerHTML='<p>Belum ada skor tersimpan.</p>'; return; }
      el.innerHTML=`<table><thead><tr><th>#</th><th>Pemain</th><th>Skor</th><th>Waktu</th></tr></thead><tbody>${
        s.map((r,i)=>`<tr>
          <td>${i+1}</td>
          <td><img src="static/avatar/${htmlescape(r.avatar||'domba')}.jpg" onerror="this.src='static/avatar/${htmlescape(r.avatar||'domba')}.png'" style="width:28px;height:28px;border-radius:50%;vertical-align:middle;margin-right:6px"> ${htmlescape(r.name)}</td>
          <td>${r.score}</td><td>${new Date(r.date).toLocaleString()}</td></tr>`).join('')
      }</tbody></table>`;
    }

    // ====== STORAGE PROGRESS ======
    function saveGameProgress(){
      localStorage.setItem(LS_KEYS.progress, JSON.stringify({playerName,playerAvatar,score,currentLevel,maxUnlockedLevel,currentTheme}));
    }
    function loadGameProgress(){
      const s=localStorage.getItem(LS_KEYS.progress); if(!s) return;
      try{
        const p=JSON.parse(s);
        playerName=p.playerName||playerName;
        if(p.playerAvatar && /^avatar\d+$/i.test(p.playerAvatar)) playerAvatar="domba"; else playerAvatar=p.playerAvatar||playerAvatar;
        score=p.score??score; currentLevel=p.currentLevel??currentLevel; maxUnlockedLevel=p.maxUnlockedLevel??maxUnlockedLevel;
        currentTheme=p.currentTheme||'light1'; applyTheme(currentTheme);
        themeBtns.forEach(b=>b.classList.toggle('active', b.dataset.theme===currentTheme));
      }catch{}
    }

    // ====== CUSTOM LEVELS (ADMIN) ======
    function loadCustomLevels(){
      try{
        const obj=JSON.parse(localStorage.getItem(LS_KEYS.custom)||'{}');
        Object.keys(obj).forEach(k=>{
          const n=Number(k); if(!n||n<1||n>100) return;
          const d=gameData[n-1], c=obj[k];
          d.customImage=c.image||null;
          d.correctAnswer=c.correct||d.correctAnswer;
          d.options=(c.options&&c.options.length===4)?c.options:d.options;
          d.mode=c.mode||d.mode;
        });
      }catch{}
    }
    function saveCustomLevel(n,payload){
      const key=LS_KEYS.custom;
      const obj=JSON.parse(localStorage.getItem(key)||'{}');
      obj[n]=payload;
      // bisa lempar error jika storage penuh
      localStorage.setItem(key, JSON.stringify(obj));
      loadCustomLevels(); renderAdminList();
    }
    function deleteCustomLevel(n){
      const key=LS_KEYS.custom;
      const obj=JSON.parse(localStorage.getItem(key)||'{}');
      delete obj[n];
      localStorage.setItem(key, JSON.stringify(obj));
      loadCustomLevels(); renderAdminList();
    }
    function renderAdminList(){
      const obj=JSON.parse(localStorage.getItem(LS_KEYS.custom)||'{}');
      const keys=Object.keys(obj).sort((a,b)=>Number(a)-Number(b));
      if(!keys.length){ $('#adm-list').innerHTML='<p>Belum ada custom level.</p>'; return; }
      $('#adm-list').innerHTML = keys.map(k=>{
        const c=obj[k];
        return `<div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
          <img class="thumb" src="${c.image||''}" alt="L${k}">
          <div>
            <div><b>Level ${k}</b> â€¢ Mode: ${c.mode||'easy'}</div>
            <div>Jawaban: ${htmlescape(c.correct||'')}</div>
            ${c.mode==='mcq' ? `<div>Opsi: ${c.options.map(htmlescape).join(' | ')}</div>` : ''}
          </div></div>`;
      }).join('');
    }

    // ====== UI ======
    function updateUI(){
      usernameEl.textContent=playerName; userScoreEl.textContent=score;
      userAvatarEl.onerror=()=>{ userAvatarEl.onerror=null; userAvatarEl.src=`static/avatar/${playerAvatar}.png`; };
      userAvatarEl.src=`static/avatar/${playerAvatar}.jpg`;
      playerNameInput.value=playerName;
      avatarOptions.forEach(a=> a.style.borderColor=(a.dataset.avatar===playerAvatar)?'#3498db':'#ddd');
      generateLevelButtons();
    }
    function showPage(id){
      pages.forEach(p=>p.classList.remove('active')); document.getElementById(id).classList.add('active');
      navLinks.forEach(l=>l.classList.toggle('active', l.dataset.page===id));
      if(id==='top-score') renderScoreboard();
      if(id==='admin') updateAdminGate();
    }
    function applyTheme(name){
      Object.entries(themes[name]).forEach(([k,v])=> document.documentElement.style.setProperty(`--${k}`,v));
      if(name.startsWith('dark')) document.body.classList.add('dark-theme'); else document.body.classList.remove('dark-theme');
      currentTheme=name; saveGameProgress();
    }
    function updateAdminGate(){
      const authed = localStorage.getItem(LS_KEYS.admin)==='1';
      adminLocked.style.display = authed ? 'none' : 'block';
      adminPanel.style.display  = authed ? 'block' : 'none';
      if(authed) renderAdminList();
    }

    // ====== EVENTS ======
    startBtn.addEventListener('click',()=>{ playerName=playerNameInput.value.trim()||'Player'; updateUI(); showPage('levels'); });
    nextBtn.addEventListener('click',()=>{ if(currentLevel<100) selectLevel(currentLevel+1); else showPage('levels'); });
    hintBtn.addEventListener('click',()=>{ const d=getLevelData(currentLevel); alert('Hint: ' + (d.correctAnswer||'').slice(0,1) + 'â€¦'); });
    saveScoreBtn.addEventListener('click',()=>{ addScore(playerName,score,playerAvatar); alert('Skor disimpan! Cek halaman Top Score.'); });
    logoutBtn.addEventListener('click',()=> showPage('home'));
    navLinks.forEach(l=> l.addEventListener('click',e=>{ e.preventDefault(); showPage(l.dataset.page);} ));
    themeBtns.forEach(b=> b.addEventListener('click',()=>{ themeBtns.forEach(x=>x.classList.remove('active')); b.classList.add('active'); applyTheme(b.dataset.theme); }));
    avatarOptions.forEach(img=> img.addEventListener('click',()=>{
      playerAvatar=img.dataset.avatar;
      userAvatarEl.onerror=()=>{ userAvatarEl.onerror=null; userAvatarEl.src=`static/avatar/${playerAvatar}.png`; };
      userAvatarEl.src=`static/avatar/${playerAvatar}.jpg`;
      avatarOptions.forEach(a=> a.style.borderColor=(a===img)?'#3498db':'#ddd'); saveGameProgress();
    }));

    // Admin
    adminLoginBtn.addEventListener('click',()=>{
      if(adminPass.value===ADMIN_PASSWORD){ localStorage.setItem(LS_KEYS.admin,'1'); adminPass.value=''; updateAdminGate(); }
      else alert('Password salah.');
    });
    admMode.addEventListener('change',()=>{ admMCQWrap.style.display = (admMode.value==='mcq') ? 'grid' : 'none'; });

    // PREVIEW + KOMPRES
    admImage.addEventListener('change', async ()=>{
      const f = admImage.files && admImage.files[0]; if(!f) return;
      try{
        const dataUrl = await fileToDataURLCompressed(f, 900, 900, 0.8);
        admPreview.src = dataUrl;
        admPreview.dataset.dataurl = dataUrl; // simpan sementara untuk disave
      }catch(e){ alert('Gagal memproses gambar: ' + (e.message||e)); }
    });

    // SIMPAN / UPDATE LEVEL
    admSave.addEventListener('click', ()=>{
      const n = Math.max(1, Math.min(100, parseInt(admLevel.value||'1',10)));
      const payload = { mode: admMode.value || 'easy', correct: (admCorrect.value||'').trim() };

      if(payload.mode==='mcq'){
        const opts = [payload.correct, (admWA.value||'').trim(), (admWB.value||'').trim(), (admWC.value||'').trim()].filter(Boolean);
        while(opts.length<4) opts.push('â€”');
        payload.options = opts.slice(0,4);
      }
      if(admPreview.dataset && admPreview.dataset.dataurl){ payload.image = admPreview.dataset.dataurl; }

      try{
        saveCustomLevel(n, payload);

        const d = gameData[n-1];
        if(payload.image) d.customImage = payload.image;
        if(payload.correct) d.correctAnswer = payload.correct;
        if(payload.options) d.options = payload.options;
        if(payload.mode) d.mode = payload.mode;

        alert(`Level ${n} disimpan!`);
        admPreview.src=''; delete admPreview.dataset.dataurl; admImage.value='';
      }catch(e){
        alert('Gagal menyimpan. Kemungkinan storage penuh. Coba unggah gambar lebih kecil / kompres.');
      }
    });

    // HAPUS CUSTOM
    admDelete.addEventListener('click', ()=>{
      const n=Math.max(1,Math.min(100,parseInt(admLevel.value||'1',10)));
      deleteCustomLevel(n);
      const d=gameData[n-1]; d.customImage=null; d.mode=GLOBAL_DEFAULT_MODE;
      alert(`Custom Level ${n} dihapus (kembali pakai file static).`);
    });

    // RESET
    admResetScore.addEventListener('click',()=>{ if(confirm('Hapus semua skor?')){ localStorage.removeItem(LS_KEYS.scores); renderScoreboard(); alert('Skor di-reset.'); }});
    admResetProgress.addEventListener('click',()=>{ if(confirm('Hapus progress pemain?')){ localStorage.removeItem(LS_KEYS.progress); score=0; currentLevel=1; maxUnlockedLevel=1; updateUI(); alert('Progress di-reset.'); }});
  </script>
</body>
</html>
